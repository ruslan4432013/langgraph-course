# Изменение состояния и обратная связь в LangGraph

Этот учебный пример демонстрирует возможности LangGraph для прерывания выполнения графа, получения обратной связи от
пользователя и ручного изменения состояния (state) во время выполнения.

## Обзор

В данном модуле рассматриваются следующие ключевые возможности:

- **Прерывания (Interrupts)**: Остановка выполнения графа перед определенными узлами для проверки состояния или ожидания
  внешнего ввода.
- **Изменение состояния (Editing State)**: Использование метода `update_state` для модификации истории сообщений или
  других данных в состоянии графа.
- **Человеческая обратная связь (Human Feedback)**: Реализация паттернов "human-in-the-loop" для подтверждения или
  корректировки действий агента.

## Структура проекта

Все основные файлы примера находятся в директории `src/editting_state_intro/`:

- `agent_with_human_feedback.py`: Определение графа агента с узлом-заглушкой `human_feedback` и настройкой прерывания (
  `interrupt_before=["human_feedback"]`).
- `editing_state_and_human_feedback.py`: Пример использования `graph.update_state` для изменения сообщения в истории и
  продолжения выполнения.
- `human_feedback_example.py`: Пример взаимодействия с пользователем через консольный ввод для обновления состояния
  графа.
- `react.py`: Базовая реализация ReAct-агента с инструментами арифметики и настроенным прерыванием перед узлом
  ассистента.
- `studio_example.py`: Пример взаимодействия с графом через LangGraph SDK (асинхронный клиент), демонстрирующий
  изменение состояния программным способом.

## Основные концепции

### 1. Прерывание выполнения

Граф компилируется с параметром `interrupt_before` или `interrupt_after`. Это позволяет остановить выполнение и
сохранить текущее состояние в контрольную точку (checkpoint).

```python
graph = builder.compile(interrupt_before=["human_feedback"], checkpointer=memory)
```

### 2. Обновление состояния

Метод `update_state` позволяет вносить изменения в состояние существующего потока (thread).

```python
graph.update_state(
    thread,
    {"messages": [HumanMessage(content="Новое сообщение")]},
)
```

### 3. Продолжение выполнения

После прерывания и возможного обновления состояния, выполнение графа можно продолжить, передав `None` в метод `stream`
или `invoke`.

```python
for event in graph.stream(None, thread, stream_mode="values"):
    # Обработка событий
```

## Инструменты

Агент в примере умеет выполнять простые арифметические операции:

- Сложение (`add`)
- Умножение (`multiply`)
- Деление (`divide`)

## Запуск

### Требования

- Python 3.10+
- Установленные зависимости из `requirements.txt`
- Файл `.env` в корне проекта с необходимыми API ключами (см. `src/settings.py`)

### Установка

```bash
pip install -r requirements.txt
```

### Примеры запуска

1. Для запуска базового примера изменения состояния:
   ```bash
   python src/editting_state_intro/editing_state_and_human_feedback.py
   ```
2. Для запуска примера с интерактивной обратной связью:
   ```bash
   python src/editting_state_intro/human_feedback_example.py
   ```

## Работа с LangGraph Studio

Проект настроен для работы с LangGraph Studio. Конфигурация находится в файле `langgraph.json`. Вы можете открыть этот
проект в Studio для визуализации графа и интерактивного тестирования прерываний.
